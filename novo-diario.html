<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Diário - Diário de Viagens</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
</head>
<body style="background-color: aliceblue;">

    <div class="page-container">
        
        <div class="header-section">
            <div class="action-bar">
                <button class="btn-salvar" id="salvarBtn" onclick="salvarDiario(event)">
                    Salvar
                </button>
            </div>

            <h1 class="header-title">Adicionar diário</h1>

            <div class="privacy-toggle-container">
                <div id="publico" class="toggle-option active" onclick="setPrivacy('publico')">
                    Público
                </div>
                <span class="toggle-separator">|</span>
                <div id="privado" class="toggle-option" onclick="setPrivacy('privado')">
                    Privado
                </div>
            </div>
        </div>

        <div class="center-visual">
            <i class="fa-solid fa-book notebook-icon" id="notebookIcon">
                <i class="fa-solid fa-paint-brush" onclick="toggleColorPicker(event)"></i>
                
                <div class="color-picker-dropdown" id="colorPicker">
                    <div class="color-option" style="background-color: red;" data-color="#FF0000" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: orange;" data-color="#FFA500" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: yellow;" data-color="#FFFF00" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: green;" data-color="#008000" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: blue;" data-color="#0000FF" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: pink;" data-color="#FFC0CB" onclick="selectColor(this)"></div>
                </div>
            </i>
        </div>

        <input type="text" id="diaryName" class="diary-title-input" placeholder="Dê um nome ao seu diário..." required />

        <div id="statusMessage" style="margin-top: 20px; text-align: center; color: var(--primary); font-weight: 600;"></div>
        
    </div>

    <script type="module">
      
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        
        let db;
        let auth;
        let userId = null;
        let selectedPrivacy = 'publico';
        let selectedColor = '#a0a0a0'; 

        const appId = 'default-app-id'; 
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        window.salvarDiario = salvarDiario;
        window.setPrivacy = setPrivacy;
        window.toggleColorPicker = toggleColorPicker;
        window.selectColor = selectColor;
        
     
        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) return;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

              
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                    } else {
                        userId = null;
                    }
                });
            } catch (error) {
                console.error("Erro ao iniciar Firebase:", error);
            }
        }

    
        function setPrivacy(status) {
            selectedPrivacy = status;
            const publico = document.getElementById('publico');
            const privado = document.getElementById('privado');

            
            publico.classList.remove('active');
            privado.classList.remove('active');
            document.getElementById(status).classList.add('active');
        }

        function toggleColorPicker(event) {
            event.stopPropagation();
            const picker = document.getElementById('colorPicker');
            picker.style.display = (picker.style.display === 'grid') ? 'none' : 'grid';
        }

      
        function selectColor(element) {
            
            selectedColor = element.getAttribute('data-color'); 
            
            
            document.getElementById('notebookIcon').style.color = selectedColor;
            
            
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            toggleColorPicker(event); 
        }

       
        
        async function salvarDiario(event) {
            event.preventDefault();
            
            const diaryName = document.getElementById('diaryName').value.trim();
            const statusMessage = document.getElementById('statusMessage');
            const salvarBtn = document.getElementById('salvarBtn');
           
            if (!diaryName) {
                statusMessage.textContent = "Insira um nome!!";
                return;
            }
            if (!db || !userId) {
                statusMessage.textContent = "Criando...";
                return;
            }

            salvarBtn.disabled = true;
            statusMessage.texsContent = "Salvando...";

            try {
               
                let collectionPath;
                if (selectedPrivacy === 'publico') {
                   
                    collectionPath = `artifacts/${appId}/public/data/diaries`;
                } else {
                
                    collectionPath = `artifacts/${appId}/users/${userId}/diaries`;
                }

             
                const newDiaryData = {
                    name: diaryName,
                    privacy: selectedPrivacy,
                    color: selectedColor, 
                    createdAt: new Date(),
                    createdBy: userId,
                };

                await addDoc(collection(db, collectionPath), newDiaryData);

                statusMessage.textContent = "Salvo com sucesso! Indo para a lista...";
                
                
                setTimeout(() => {
                    window.location.href = "index.html"; 
                }, 1500);

            } catch (error) {
                console.error("Erro ao salvar:", error);
                statusMessage.textContent = "Erro ao salvar: " + error.message;
            } finally {
                salvarBtn.disabled = false;
            }
        }
       
        initFirebase();
        
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('colorPicker');
            const brush = document.querySelector('.fa-paint-brush');
            if (picker.style.display === 'grid' && !picker.contains(e.target) && e.target !== brush) {
                picker.style.display = 'none';
            }
        });

    </script>
</body>
</html>