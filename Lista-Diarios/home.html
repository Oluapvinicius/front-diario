<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Diários - Diário de Viagens</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar"></aside>
        <main class="main-content">
            <header class="home-header">
                <h1>Meus Diários de Viagens</h1>
                <p style="color: var(--secondary-text);">Aqui estão todos os seus diários. Clique para ver os detalhes e viagens.</p>
            </header>
            <div class="home-actions">
                <a href="../Diario-criarDiario/novo-diario.html" class="btn-primary" style="width: auto;"> 
                    <i class="fa-solid fa-plus"></i> Novo Diário
                </a>
            </div>
            <section class="diary-grid"></section>
        </main>
    </div>

    <script>
        function getUserId() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                window.location.href = "../index.html";
                return null;
            }
            return parseInt(userId);
        }

        async function carregarDados() {
            const idUsuario = getUserId();
            if (!idUsuario) return;

            try {
                const urlDiarios = `http://localhost:8080/v1/travel/diario/meusDiarios/${idUsuario}`;
                const urlCores = 'http://localhost:8080/v1/travel/cor';

                const responseCores = await fetch(urlCores);
                const jsonCores = await responseCores.json();
                const cores = jsonCores.response?.colors || [];

                const responseDiarios = await fetch(urlDiarios);
                const jsonDiarios = await responseDiarios.json();

                let diarios = [];
                if (jsonDiarios.response && Array.isArray(jsonDiarios.response)) {
                    diarios = jsonDiarios.response;
                } else if (jsonDiarios.response && !Array.isArray(jsonDiarios.response)) {
                    diarios = [jsonDiarios.response];
                } else if (Array.isArray(jsonDiarios)) {
                    diarios = jsonDiarios;
                }

                exibirDiarios(diarios, cores);
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                alert("Erro ao carregar diários. Verifique o servidor.");
            }
        }

        function exibirDiarios(diarios, cores) {
            const container = document.querySelector('.diary-grid');
            container.innerHTML = '';

            diarios.forEach(diario => {
                const corEncontrada = cores.find(c => c.id_cor === diario.id_cor);
                const hexCode = corEncontrada ? corEncontrada.hex_code : '#ccc';

                const card = document.createElement('div');
                card.className = 'diary-card';
                card.id = `card-${diario.id_diario}`;

                const header = document.createElement('div');
                header.className = 'diary-card-header';
                header.style.backgroundColor = hexCode;

                const content = document.createElement('div');
                content.className = 'diary-card-content';

                const title = document.createElement('h2');
                title.className = 'diary-card-title';
                title.textContent = diario.nome;
                title.onclick = function() { 
                    localStorage.setItem('currentDiaryId', diario.id_diario);
                    localStorage.setItem('currentDiaryName', diario.nome);
                    window.location.href = "./home-principal.html";
                };

                const meta = document.createElement('div');
                meta.className = 'diary-card-meta';

                const spanViagens = document.createElement('span');
                const iconPlane = document.createElement('i');
                iconPlane.className = 'fa-solid fa-plane card-icon';
                spanViagens.appendChild(iconPlane);
                spanViagens.appendChild(document.createTextNode(` ${diario.quantidade_viagens || 0} Viagens`));

                const spanPrivacidade = document.createElement('span');
                const isPublico = diario.isPublico === true || diario.isPublico === 1;
                const iconLockClass = isPublico ? 'fa-lock-open' : 'fa-lock';
                const textLock = isPublico ? ' Público' : ' Privado';
                const iconLock = document.createElement('i');
                iconLock.className = `fa-solid ${iconLockClass} card-icon`;
                spanPrivacidade.appendChild(iconLock);
                spanPrivacidade.appendChild(document.createTextNode(textLock));

                meta.appendChild(spanViagens);
                meta.appendChild(spanPrivacidade);
                content.appendChild(title);
                content.appendChild(meta);
                card.appendChild(header);
                card.appendChild(content);
                container.appendChild(card);
            });
        }

        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>