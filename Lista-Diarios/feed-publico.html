<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed de Postagens Públicas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="./home-principal.css">
    <link rel="stylesheet" href="./feed-publico.css">
</head>
<body class="main-body">
    <header class="diary-header">
        <div class="header-left">
            <button class="icon-btn" onclick="window.location.href='home-principal.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-logo">Feed de Viagens</div>
        </div>
        <div class="main-search-row" style="margin:0; width: 400px; max-width: 50%;">
            <input type="text" id="search-input" class="form-input main-search-input" placeholder="Buscar viagem ou usuário..." oninput="filtrarFeed()"/>
            <button class="icon-btn search-align-center" style="margin-left: -50px;" onclick="filtrarFeed()">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div class="header-right">
            <button class="icon-btn" onclick="window.location.href='perfil-publico.html'">
                <i class="fas fa-user-circle"></i>
            </button>
        </div>
    </header>

    <div class="feed-main-content" id="public-feed-container"></div>

    <script>
        let allPosts = [];

        async function carregarFeedPublico() {
            try {
                const response = await fetch('http://localhost:8080/v1/travel/viagem');
                const data = await response.json();
                
                if (data.status_code !== 200 || !data.response.viagens) {
                    console.error("Erro ao carregar feed");
                    return [];
                }
                
                const viagensPublicas = data.response.viagens.filter(v => v.isPublico === true || v.isPublico === 1);
                
                const postsFormatados = await Promise.all(
                    viagensPublicas.map(async (viagem) => {
                        try {
                            const responseUsuario = await fetch(`http://localhost:8080/v1/travel/usuario/${viagem.id_usuario}`);
                            const dataUsuario = await responseUsuario.json();
                            
                            const usuario = dataUsuario.status_code === 200 ? dataUsuario.response : {
                                user_nome: "Usuário",
                                nome: "Usuário"
                            };
                            
                            const dataObj = new Date(viagem.data_inicio);
                            const diaSemana = dataObj.toLocaleDateString('pt-BR', { weekday: 'short' }).toUpperCase().replace('.', '');
                            const dataFormatada = `${String(dataObj.getDate()).padStart(2, '0')}/${String(dataObj.getMonth() + 1).padStart(2, '0')}`;
                            const horario = dataObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            
                            return {
                                id_viagem: viagem.id_viagem,
                                nome_viagem: viagem.nome,
                                descricao_viagem: viagem.descricao,
                                data_inicio: dataFormatada,
                                dia_semana: diaSemana,
                                horario: horario,
                                local_resumo: "Localização",
                                isPublico: true,
                                usuario: {
                                    id_usuario: viagem.id_usuario,
                                    user_nome: usuario.user_nome || usuario.nome
                                }
                            };
                        } catch (error) {
                            console.error("Erro ao processar viagem:", error);
                            return null;
                        }
                    })
                );
                
                return postsFormatados.filter(post => post !== null);
                
            } catch (error) {
                console.error("Erro ao carregar feed:", error);
                return [];
            }
        }

        function createPostCard(post) {
            const card = document.createElement('div');
            card.className = 'post-card';
       
            const userHeaderFeed = document.createElement('div');
            userHeaderFeed.className = 'user-header-feed';

            const profilePicFeed = document.createElement('div');
            profilePicFeed.className = 'profile-pic-feed';
            profilePicFeed.onclick = () => {
                localStorage.setItem('selectedUserId', post.usuario.id_usuario);
                window.location.href = "perfil-publico.html";
            };
            profilePicFeed.style.cursor = 'pointer';

            const profileImg = document.createElement('div');
            profileImg.style.width = '100%';
            profileImg.style.height = '100%';
            profileImg.style.display = 'flex';
            profileImg.style.alignItems = 'center';
            profileImg.style.justifyContent = 'center';
            profileImg.style.backgroundColor = 'var(--primary)';
            profileImg.style.color = 'white';
            profileImg.style.fontWeight = 'bold';
            profileImg.textContent = post.usuario.user_nome ? post.usuario.user_nome.charAt(0).toUpperCase() : 'U';

            profilePicFeed.appendChild(profileImg);

            const usernameFeed = document.createElement('span');
            usernameFeed.className = 'username-feed';
            usernameFeed.onclick = () => {
                localStorage.setItem('selectedUserId', post.usuario.id_usuario);
                window.location.href = "perfil-publico.html";
            };
            usernameFeed.style.cursor = 'pointer';
            usernameFeed.textContent = post.usuario.user_nome;

            userHeaderFeed.appendChild(profilePicFeed);
            userHeaderFeed.appendChild(usernameFeed);
            card.appendChild(userHeaderFeed);

            const postBodyFeed = document.createElement('div');
            postBodyFeed.className = 'post-body-feed';

            const postDateFeed = document.createElement('div');
            postDateFeed.className = 'post-date-feed';

            const dayName = document.createElement('div');
            dayName.className = 'day-name';
            dayName.textContent = post.dia_semana;

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = post.data_inicio.split('/')[0];

            postDateFeed.appendChild(dayName);
            postDateFeed.appendChild(dayNumber);

            const postContentFeed = document.createElement('div');
            postContentFeed.className = 'post-content-feed';

            const tripMediaFeed = document.createElement('div');
            tripMediaFeed.className = 'trip-media-feed';

            const mediaDiv = document.createElement('div');
            mediaDiv.style.width = '100%';
            mediaDiv.style.height = '100%';
            mediaDiv.style.backgroundColor = 'var(--primary)';
            mediaDiv.style.opacity = '0.8';
            mediaDiv.style.display = 'flex';
            mediaDiv.style.alignItems = 'center';
            mediaDiv.style.justifyContent = 'center';
            mediaDiv.style.color = 'white';
            mediaDiv.style.fontSize = '2rem';
            mediaDiv.innerHTML = '<i class="fas fa-globe-americas"></i>';

            tripMediaFeed.appendChild(mediaDiv);

            const title = document.createElement('h2');
            title.className = 'title';
            title.textContent = post.nome_viagem;

            const description = document.createElement('p');
            description.className = 'description';
            description.textContent = post.descricao_viagem || 'Sem descrição';

            const postFooterFeed = document.createElement('div');
            postFooterFeed.className = 'post-footer-feed';

            const locationDiv = document.createElement('div');
            locationDiv.className = 'location';

            const mapIcon = document.createElement('i');
            mapIcon.className = 'fas fa-map-marker-alt';

            const locationSpan = document.createElement('span');
            locationSpan.textContent = `${post.horario} | ${post.local_resumo}`;

            locationDiv.appendChild(mapIcon);
            locationDiv.appendChild(locationSpan);

            postFooterFeed.appendChild(locationDiv);
            postContentFeed.appendChild(tripMediaFeed);
            postContentFeed.appendChild(title);
            postContentFeed.appendChild(description);
            postContentFeed.appendChild(postFooterFeed);
            postBodyFeed.appendChild(postDateFeed);
            postBodyFeed.appendChild(postContentFeed);
            card.appendChild(postBodyFeed);

            return card;
        }

        function filtrarFeed() {
            const termoBusca = document.getElementById('search-input').value.toLowerCase();
            const postsFiltrados = allPosts.filter(post => {
                const nomeViagem = post.nome_viagem.toLowerCase();
                const nomeUsuario = post.usuario.user_nome.toLowerCase();
                return nomeViagem.includes(termoBusca) || nomeUsuario.includes(termoBusca);
            });
            renderFeed(postsFiltrados);
        }

        function renderFeed(listaPosts) {
            const feedContainer = document.getElementById('public-feed-container');
            feedContainer.innerHTML = '';

            if (listaPosts.length === 0) {
                const div = document.createElement('div');
                div.style.textAlign = 'center';
                div.style.marginTop = '50px';
                div.style.color = 'var(--secondary-text)';
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-search';
                icon.style.fontSize = '2rem';
                icon.style.marginBottom = '15px';
                icon.style.opacity = '0.5';

                const p = document.createElement('p');
                p.textContent = 'Nenhuma viagem ou usuário encontrado.';

                div.appendChild(icon);
                div.appendChild(p);
                feedContainer.appendChild(div);
                return;
            }

            listaPosts.forEach(post => {
                const postCard = createPostCard(post);
                feedContainer.appendChild(postCard);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const feedContainer = document.getElementById('public-feed-container');
            feedContainer.innerHTML = '<div style="text-align:center; padding: 40px;">Carregando feed público...</div>';
            
            allPosts = await carregarFeedPublico();
            renderFeed(allPosts);
        });
    </script>
</body>
</html>