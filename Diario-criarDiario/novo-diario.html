<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Diário - Diário de Viagens</title>
    <link rel="stylesheet" href="novo-diario.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body style="background-color: aliceblue;">

    <div class="page-container">
        <div class="header-section">
            <div class="action-bar">
                <button class="btn-salvar" id="salvarBtn" onclick="salvarDiario(event)">
                    Salvar
                </button>
            </div>

            <h1 class="header-title" id="pageTitle">Adicionar diário</h1>
            <p id="limitMessage" style="color: var(--primary); text-align: center; margin-bottom: 20px;"></p>

            <div class="privacy-toggle-container">
                <div id="publico" class="toggle-option active" onclick="setPrivacy('publico')">
                    Público
                </div>
                <span class="toggle-separator">|</span>
                <div id="privado" class="toggle-option" onclick="setPrivacy('privado')">
                    Privado
                </div>
            </div>
        </div>

        <div class="center-visual">
            <i class="fa-solid fa-book notebook-icon" id="notebookIcon">
                <i class="fa-solid fa-paint-brush" onclick="toggleColorPicker(event)"></i>

                <div class="color-picker-dropdown" id="colorPicker">
                    <div class="color-option" style="background-color: red;" data-color="#FF0000" data-idcor="1"
                        onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: orange;" data-color="#FFA500" data-idcor="2"
                        onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: yellow;" data-color="#FFFF00" data-idcor="3"
                        onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: green;" data-color="#008000" data-idcor="4"
                        onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: blue;" data-color="#0000FF" data-idcor="5"
                        onclick="selectColor(this)"></div>
                    <div class="color-option" style="background-color: pink;" data-color="#FFC0CB" data-idcor="6"
                        onclick="selectColor(this)"></div>
                </div>
            </i>
        </div>

        <input type="text" id="diaryName" class="diary-title-input" placeholder="Dê um nome ao seu diário..."
            required />

        <div id="statusMessage"></div>

    </div>

    <script>
        const MAX_DIARIES_PER_USER = 10;
        window.salvarDiario = salvarDiario;
        window.setPrivacy = setPrivacy;
        window.toggleColorPicker = toggleColorPicker;
        window.selectColor = selectColor;

        let idUsuarioLogado = localStorage.getItem('userId') ? parseInt(localStorage.getItem('userId')) : null;
        let selectedPrivacy = 'publico';
        let selectedColor = '#A0A0A0';
        let idCorSelecionada = 1;
        let isEditing = false;
        let editDiaryId = null;

        async function checkDiaryLimit() {
            if (!idUsuarioLogado) return false;
            
            try {
                // Buscar todos os diários e filtrar pelos do usuário
                const response = await fetch(`http://localhost:8080/v1/travel/diario`);
                const json = await response.json();
                
                let todosOsDiarios = [];
                if (json.response && json.response.diarios) {
                    todosOsDiarios = json.response.diarios;
                } else if (Array.isArray(json.response)) {
                    todosOsDiarios = json.response;
                } else if (Array.isArray(json)) {
                    todosOsDiarios = json;
                }
                
                // Filtrar diários do usuário
                const meusDiarios = todosOsDiarios.filter(diario => 
                    diario.id_usuario == idUsuarioLogado
                );
                
                const userDiaryCount = meusDiarios.length;
                updateLimitMessage(userDiaryCount);
                
                return userDiaryCount >= MAX_DIARIES_PER_USER;
            } catch (error) {
                console.error("Erro ao verificar limite:", error);
                return false;
            }
        }

        function updateLimitMessage(count) {
            const limitMessage = document.getElementById('limitMessage');
            if (limitMessage) {
                limitMessage.textContent = `Você tem ${count} de ${MAX_DIARIES_PER_USER} diários.`;
                
                if (count >= MAX_DIARIES_PER_USER && !isEditing) {
                    limitMessage.style.color = '#ff6b6b';
                    limitMessage.textContent += `LIMITE ATINGIDO!`;
                    
                    // Desabilitar campos apenas se não for edição
                    document.getElementById('diaryName').disabled = true;
                    document.getElementById('diaryName').placeholder = "Limite máximo atingido";
                    document.getElementById('salvarBtn').disabled = true;
                    document.getElementById('salvarBtn').style.opacity = '0.5';
                    document.getElementById('salvarBtn').style.cursor = 'not-allowed';
                } else {
                    limitMessage.style.color = 'var(--primary)';
                    
                    // Habilitar campos
                    document.getElementById('diaryName').disabled = false;
                    document.getElementById('diaryName').placeholder = "Dê um nome ao seu diário...";
                    document.getElementById('salvarBtn').disabled = false;
                    document.getElementById('salvarBtn').style.opacity = '1';
                    document.getElementById('salvarBtn').style.cursor = 'pointer';
                }
            }
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function loadDiaryForEditing() {
            const acao = getQueryParam('acao');
            const diarioId = getQueryParam('id');

            if (acao === 'editar' && diarioId) {
                isEditing = true;
                editDiaryId = diarioId;
                document.getElementById('pageTitle').textContent = "Editar diário";
                document.getElementById('salvarBtn').textContent = "Atualizar";

                // Não aplicar limite para edição
                document.getElementById('limitMessage').style.display = 'none';
                
                const dadosMock = carregarDadosDiario(diarioId);
                if (dadosMock) {
                    document.getElementById('diaryName').value = dadosMock.nome;
                    setPrivacy(dadosMock.isPublico ? 'publico' : 'privado');
                    selectColor(null, dadosMock.cor, dadosMock.idCor || 1);
                }
            }
        }

        function setPrivacy(status) {
            selectedPrivacy = status;
            const publico = document.getElementById('publico');
            const privado = document.getElementById('privado');
            publico.classList.remove('active');
            privado.classList.remove('active');
            document.getElementById(status).classList.add('active');
        }

        function toggleColorPicker(event) {
            event.stopPropagation();
            const picker = document.getElementById('colorPicker');
            picker.style.display = (picker.style.display === 'grid') ? 'none' : 'grid';
        }

        function selectColor(element, colorParam, idCorParam) {
            const color = colorParam || element.getAttribute('data-color');
            const idCor = idCorParam || (element ? parseInt(element.getAttribute('data-idcor')) : 1);

            selectedColor = color;
            idCorSelecionada = idCor;

            document.getElementById('notebookIcon').style.color = selectedColor;

            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            if (element) element.classList.add('selected');

            if (element) {
                const picker = document.getElementById('colorPicker');
                if (picker.style.display === 'grid') {
                    picker.style.display = 'none';
                }
            }
        }

        async function salvarDiario(event) {
            event.preventDefault();

            // Verificar limite apenas se não for edição
            if (!isEditing) {
                const isLimitReached = await checkDiaryLimit();
                if (isLimitReached) {
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.textContent = `Você atingiu o limite máximo de ${MAX_DIARIES_PER_USER} diários.`;
                    statusMessage.style.color = 'red';
                    return;
                }
            }

            const diaryName = document.getElementById('diaryName').value.trim();
            const statusMessage = document.getElementById('statusMessage');
            const salvarBtn = document.getElementById('salvarBtn');
            const isPublico = selectedPrivacy === 'publico';

            if (!diaryName) {
                statusMessage.textContent = "Insira um nome!";
                statusMessage.style.color = 'red';
                return;
            }
            if (!idUsuarioLogado) {
                statusMessage.textContent = "Erro: Usuário não logado. Redirecionando...";
                statusMessage.style.color = 'red';
                setTimeout(() => window.location.href = "../index.html", 1000);
                return;
            }

            salvarBtn.disabled = true;
            statusMessage.textContent = isEditing ? "Atualizando..." : "Salvando...";
            statusMessage.style.color = '#000';

            const diaryData = {
                id_usuario: idUsuarioLogado,
                nome: diaryName,
                isPublico: isPublico,
                id_cor: idCorSelecionada,
                quantidade_viagens: 0,
                descricao: 'Um diário de viagens.'
            };

            let endpoint = `http://localhost:8080/v1/travel/diario`;
            let method = 'POST';

            if (isEditing) {
                method = 'PUT';
                endpoint = `http://localhost:8080/v1/travel/diario/${editDiaryId}`;
                diaryData.id_diario = parseInt(editDiaryId);
            }

            try {
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(diaryData),
                });

                const data = await response.json();

                if (response.ok || data.status_code === 201 || data.status_code === 200) {
                    statusMessage.textContent = isEditing ? "Atualizado com sucesso!" : "Salvo com sucesso!";
                    statusMessage.style.color = 'green';

                    let nextUrl = "../Lista-Diarios/home.html";

                    if (!isEditing && data.response && data.response.id_diario) {
                        nextUrl = `../Lista-Diarios/home-principal.html?id_diario=${data.response.id_diario}`;
                    }

                    setTimeout(() => {
                        window.location.href = nextUrl;
                    }, 1500);

                } else {
                    const errorMessage = data.invalid_field || data.message || "Erro desconhecido da API.";
                    statusMessage.textContent = `Erro ao salvar: ${errorMessage}`;
                    statusMessage.style.color = 'red';
                }

            } catch (error) {
                console.error("Erro ao salvar/atualizar:", error);
                statusMessage.textContent = "Erro de conexão. Verifique se o servidor está ativo.";
                statusMessage.style.color = 'red';
            } finally {
                salvarBtn.disabled = false;
            }
        }

        function carregarDadosDiario(id) {
            if (id == 1) {
                return { nome: 'Diário Europa 2025', isPublico: true, cor: '#00A896', idCor: 4 };
            }
            return null;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!idUsuarioLogado) {
                document.getElementById('statusMessage').textContent = "Você não está logado.";
            }

            selectColor(null, selectedColor, idCorSelecionada);
            loadDiaryForEditing();
            
            // Verificar limite ao carregar a página apenas se não for edição
            if (!isEditing) {
                await checkDiaryLimit();
            }
        });

        document.addEventListener('click', (e) => {
            const picker = document.getElementById('colorPicker');
            const brush = document.querySelector('.fa-paint-brush');
            const iconContainer = document.querySelector('.notebook-icon');

            if (picker.style.display === 'grid' &&
                !picker.contains(e.target) &&
                e.target !== brush &&
                e.target.parentNode !== iconContainer) {
                picker.style.display = 'none';
            }
        });
    </script>
</body>

</html>