<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Diário de Viagens</title>
    <link rel="stylesheet" href="login-cadastro.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body style="height: auto;">

    <div class="auth-container">
        <div class="auth-card cadastro">
            <div class="logo">
                <i class="fa-solid fa-map-location-dot"></i>
                Diário de Viagens
            </div>

            <h2>Crie sua conta</h2>

            <form id="cadastroForm" onsubmit="realizarCadastro(event)">

                <div class="form-group">
                    <label for="nome" class="form-label">Nome Completo</label>
                    <input type="text" id="nome" class="form-input" required autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="user_nome" class="form-label">Nome de Usuário</label>
                    <input type="text" id="user_nome" class="form-input" placeholder="Ex: RobertoViajante" required
                        autocomplete="nickname">
                </div>

                <div class="form-group">
                    <label for="email_cadastro" class="form-label">E-mail</label>
                    <input type="email" id="email_cadastro" class="form-input" placeholder="seu@email.com" required
                        autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                    <input type="date" id="data_nascimento" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="genero" class="form-label">Gênero</label>
                    <select id="id_genero" class="form-input" required>
                        <option value="">Selecione</option>
                        <option value="1">Masculino</option>
                        <option value="2">Feminino</option>
                        <option value="3">Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="senha_cadastro" class="form-label">Senha</label>
                    <input type="password" id="senha_cadastro" class="form-input" placeholder="********" required
                        autocomplete="new-password">
                </div>

                <div class="form-group">
                    <label for="confirmar_senha" class="form-label">Confirmar Senha</label>
                    <input type="password" id="confirmar_senha" class="form-input" placeholder="********" required
                        autocomplete="new-password">
                </div>

                <button type="submit" class="btn-primary">Cadastrar</button>
            </form>

            <div class="auth-links">
                <p>Já tem uma conta? <a href="index.html">Faça login</a></p>
            </div>
        </div>
    </div>

    <script>
        function exibirMensagem(texto, tipo = 'error') {
            const form = document.getElementById('cadastroForm');
            let errorMessage = form.querySelector('.auth-message');

            if (!errorMessage) {
                errorMessage = document.createElement('div');
                errorMessage.className = 'auth-message';
                form.prepend(errorMessage);
            }

            if (tipo === 'success') {
                errorMessage.style.cssText = "padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px; margin-bottom: 15px; text-align: center;";
            } else {
                errorMessage.style.cssText = "padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; margin-bottom: 15px; text-align: center;";
            }

            errorMessage.textContent = texto;
            setTimeout(() => errorMessage.remove(), 5000);
        }

        function formatarDataAtual() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function realizarCadastro(event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value;
            const user_nome = document.getElementById('user_nome').value;
            const email = document.getElementById('email_cadastro').value;
            const data_nascimento = document.getElementById('data_nascimento').value;
            const id_genero = parseInt(document.getElementById('id_genero').value);
            const senha = document.getElementById('senha_cadastro').value;
            const confirmar_senha = document.getElementById('confirmar_senha').value;

            if (senha !== confirmar_senha) {
                exibirMensagem("As senhas digitadas não coincidem. Por favor, verifique.");
                document.getElementById('senha_cadastro').focus();
                return;
            }

            if (!id_genero) {
                exibirMensagem("Por favor, selecione um gênero.");
                return;
            }

            const dataFormatada = new Date(data_nascimento).toISOString().split('T')[0];

            const dadosCadastroVersao1 = {
                USER_NOME: user_nome,
                NOME: nome,
                DESCRICAO: "Novo usuário. Acrescente uma descrição aqui",
                DATA_NASCIMENTO: dataFormatada,
                TELEFONE: "",
                EMAIL: email,
                SENHA: senha,
                PAIS: "",
                ESTADO: "",
                CIDADE: "",
                QUANTIDADE_SEGUIDORES: 0,
                QUANTIDADE_SEGUINDO: 0,
                ISACTIVE: true,
                ISPUBLICO: true,
                ID_GENERO: id_genero
            };

            const dadosCadastroVersao2 = {
                user_nome: user_nome,
                nome: nome,
                descricao: "Novo usuário. Acrescente uma descrição aqui",
                data_nascimento: dataFormatada,
                telefone: "",
                email: email,
                senha: senha,
                pais: "",
                estado: "",
                cidade: "",
                quantidade_seguidores: 0,
                quantidade_seguindo: 0,
                isActive: true,
                isPublico: true,
                id_genero: id_genero
            };

            const dadosCadastroVersao3 = {
                user_nome: user_nome,
                nome: nome,
                descricao: "Novo usuário. Acrescente uma descrição aqui",
                data_nascimento: dataFormatada,
                telefone: "",
                email: email,
                senha: senha,
                pais: "",
                estado: "",
                cidade: "",
                quantidade_seguidores: 0,
                quantidade_seguindo: 0,
                isActive: true,
                isPublico: true,
                id_genero: id_genero 
            };

            console.log("Enviando dados para cadastro:", dadosCadastroVersao3);

            try {
                const response = await fetch('http://localhost:8080/v1/travel/usuario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosCadastroVersao3),
                });

                const data = await response.json();
                console.log("Resposta da API:", data);
                
                if (data.status_code === 201 || response.ok) {
                    exibirMensagem("Cadastro realizado com sucesso! Redirecionando para o login...", 'success');
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 2000);
                } else {
                    // Verifique o campo específico do erro
                    if (data.invalid_field && data.invalid_field.includes('ID_GENERO')) {
                        exibirMensagem(`Erro: O campo de gênero não está no formato correto. Detalhes: ${data.message}`);
                    } else {
                        exibirMensagem(`Erro ao cadastrar: ${data.message || 'Erro desconhecido.'}`);
                    }
                }
            } catch (error) {
                console.error("Erro na requisição:", error);
                exibirMensagem("Erro de conexão. Verifique o servidor da API.");
            }
        }
    </script>
</body>

</html>